<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Generator - Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .login-section {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .admin-panel {
            display: none;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h3 {
            color: #555;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        .warning {
            background: #ffc107;
            color: #212529;
        }
        .warning:hover {
            background: #e0a800;
        }
        .login-btn {
            background: #28a745;
            width: 100%;
            padding: 15px;
            font-size: 18px;
        }
        .logout-btn {
            background: #6c757d;
            float: right;
            padding: 8px 16px;
            font-size: 14px;
        }
        #output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-bar {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .stats-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .stats-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stats-label {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }
        .stats-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .users-card { border-color: #007bff; }
        .users-card .stats-number { color: #007bff; }
        .portfolios-card { border-color: #28a745; }
        .portfolios-card .stats-number { color: #28a745; }
        .forms-card { border-color: #ffc107; }
        .forms-card .stats-number { color: #ffc107; }
        .total-card { border-color: #6f42c1; }
        .total-card .stats-number { color: #6f42c1; }
        .storage-card { border-color: #17a2b8; }
        .storage-card .stats-number { color: #17a2b8; }
        .database-card { border-color: #fd7e14; }
        .database-card .stats-number { color: #fd7e14; }
        .bandwidth-card { border-color: #e83e8c; }
        .bandwidth-card .stats-number { color: #e83e8c; }
        .health-card { border-color: #20c997; }
        .health-card .stats-number { color: #20c997; }
        .storage-info {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
            font-weight: normal;
        }
        .storage-progress { background: linear-gradient(90deg, #17a2b8, #138496); }
        .database-progress { background: linear-gradient(90deg, #fd7e14, #e8590c); }
        .bandwidth-progress { background: linear-gradient(90deg, #e83e8c, #d91a72); }
        .health-progress { background: linear-gradient(90deg, #20c997, #1aa179); }
        .chart-container {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-title {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        .sample-users {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #28a745);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Portfolio Generator - Admin Panel</h1>
        
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="text-align: center; color: #333; margin-bottom: 30px;">üîê Admin Login</h2>
            
            <div class="input-group">
                <label for="loginUsername">Username:</label>
                <input type="text" id="loginUsername" placeholder="Enter admin username">
            </div>
            
            <div class="input-group">
                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" placeholder="Enter admin password">
            </div>
            
            <button class="login-btn" onclick="adminLogin()">üöÄ Login to Admin Panel</button>
            
            <div id="loginOutput" style="margin-top: 20px;"></div>
        </div>

        <!-- Admin Panel (Hidden until login) -->
        <div id="adminPanel" class="admin-panel" style="display: none !important;">
            <div class="status-bar">
                <div>
                    <strong>üë§ Logged in as:</strong> <span id="currentUser">whatlead</span>
                    <strong style="margin-left: 20px;">üïí Session:</strong> <span id="sessionTime">Active</span>
                </div>
                <button class="logout-btn" onclick="adminLogout()">üö™ Logout</button>
            </div>
            
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Warning:</strong> This tool will permanently delete user data. Make sure you have backups if needed.
            </div>

            <div class="section">
                <h3>üìä Database Statistics</h3>
                <p>Check current database status before cleanup</p>
                <div class="alert alert-info" style="background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; margin: 15px 0;">
                    <strong>üìã What these metrics mean:</strong><br>
                    ‚Ä¢ <strong>Total Users:</strong> Registered user accounts<br>
                    ‚Ä¢ <strong>Portfolios:</strong> Created portfolio websites<br>
                    ‚Ä¢ <strong>Contact Forms:</strong> Feedback and contact form submissions<br>
                    ‚Ä¢ <strong>Active Users:</strong> Users who have created at least one portfolio<br>
                    ‚Ä¢ <strong>Render Storage:</strong> File storage on Render (512 MB free tier limit)<br>
                    ‚Ä¢ <strong>MongoDB Storage:</strong> Database storage (512 MB free tier limit)<br>
                    ‚Ä¢ <strong>Bandwidth:</strong> Monthly data transfer (estimated based on usage)
                </div>
                <button onclick="getStats()">üìà Get Database Stats</button>
                
                <!-- Visual statistics removed for simplicity -->
                    <!-- Stats Cards -->
                    <div class="stats-container">
                        <div class="stats-card users-card">
                            <div class="stats-icon">üë•</div>
                            <div class="stats-number" id="usersCount">0</div>
                            <div class="stats-label">Total Users</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="usersProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="stats-card portfolios-card">
                            <div class="stats-icon">üìÅ</div>
                            <div class="stats-number" id="portfoliosCount">0</div>
                            <div class="stats-label">Portfolios</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="portfoliosProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="stats-card forms-card">
                            <div class="stats-icon">üìù</div>
                            <div class="stats-number" id="formsCount">0</div>
                            <div class="stats-label">Contact Forms</div>
                            <div class="storage-info">Feedback & Contact submissions</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="formsProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="stats-card total-card">
                            <div class="stats-icon">‚ö°</div>
                            <div class="stats-number" id="activeUsersCount">0</div>
                            <div class="stats-label">Active Users</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="activeUsersProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Storage Usage Cards -->
                    <div class="stats-container">
                        <div class="stats-card storage-card">
                            <div class="stats-icon">üíæ</div>
                            <div class="stats-number" id="renderStorageUsed">0</div>
                            <div class="stats-label">Render Storage</div>
                            <div class="storage-info" id="renderStorageInfo">0 MB / 512 MB</div>
                            <div class="progress-bar">
                                <div class="progress-fill storage-progress" id="renderStorageProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="stats-card database-card">
                            <div class="stats-icon">üóÑÔ∏è</div>
                            <div class="stats-number" id="mongoStorageUsed">0</div>
                            <div class="stats-label">MongoDB Storage</div>
                            <div class="storage-info" id="mongoStorageInfo">0 MB / 512 MB</div>
                            <div class="progress-bar">
                                <div class="progress-fill database-progress" id="mongoStorageProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="stats-card bandwidth-card">
                            <div class="stats-icon">üì°</div>
                            <div class="stats-number" id="bandwidthUsed">0</div>
                            <div class="stats-label">Bandwidth Used</div>
                            <div class="storage-info" id="bandwidthInfo">0 GB / 100 GB</div>
                            <div class="progress-bar">
                                <div class="progress-fill bandwidth-progress" id="bandwidthProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="stats-card health-card">
                            <div class="stats-icon">üíö</div>
                            <div class="stats-number" id="systemHealth">100</div>
                            <div class="stats-label">System Health</div>
                            <div class="storage-info" id="healthInfo">All systems operational</div>
                            <div class="progress-bar">
                                <div class="progress-fill health-progress" id="healthProgress" style="width: 100%">100%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div class="chart-container">
                        <div class="chart-title">üìà Database Overview</div>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="statsChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Sample Users Display -->
                    <div id="sampleUsersContainer" style="display: none;">
                        <div class="chart-container">
                            <div class="chart-title">üë• Recent Users</div>
                            <div id="sampleUsersList" class="sample-users"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üíæ Backup Data (Recommended)</h3>
                <p>Create a backup of all data before deletion</p>
                <button class="warning" onclick="backupData()">üíæ Create Backup</button>
            </div>

            <div class="section">
                <h3>üóëÔ∏è Delete Specific User</h3>
                <div class="input-group">
                    <label for="userEmail">User Email:</label>
                    <input type="email" id="userEmail" placeholder="user@example.com">
                </div>
                <button class="danger" onclick="deleteSpecificUser()">üóëÔ∏è Delete This User</button>
            </div>

            <div class="section">
                <h3>üßπ Delete ALL Test Users</h3>
                <div class="alert alert-danger">
                    <strong>‚ö†Ô∏è DANGER:</strong> This will delete ALL users and their portfolios from the database!
                </div>
                <button class="danger" onclick="deleteAllUsers()">üö® DELETE ALL USERS</button>
            </div>

            <div class="section">
                <h3>üõ†Ô∏è Debug Tools</h3>
                <button onclick="clearOutput()" class="warning">üßπ Clear Output</button>
                <button onclick="showDebugInfo()" class="warning">üîç Show Debug Info</button>
            </div>

            <div id="output"></div>
        </div>
    </div>

    <script>
        // Use the current origin for API calls (works in both dev and production)
        const API_BASE = window.location.origin;
        let adminCredentials = null;
        
        function log(message, isLogin = false) {
            const outputId = isLogin ? 'loginOutput' : 'output';
            const output = document.getElementById(outputId);
            const timestamp = new Date().toLocaleTimeString();
            
            if (isLogin) {
                output.innerHTML = `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; font-family: monospace;">[${timestamp}] ${message}</div>`;
            } else {
                output.textContent += `[${timestamp}] ${message}\n`;
                output.scrollTop = output.scrollHeight;
            }
        }
        
        async function adminLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                log('‚ùå Please enter both username and password', true);
                return;
            }
            
            try {
                log('üîê Attempting admin login...', true);
                
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Login successful! Redirecting to admin panel...', true);
                    adminCredentials = data.credentials;
                    
                    // Hide login section and show admin panel
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    
                    // Update status bar
                    document.getElementById('currentUser').textContent = username;
                    document.getElementById('sessionTime').textContent = new Date().toLocaleTimeString();
                    
                    // Initialize admin panel
                    log('üõ†Ô∏è Admin Panel Ready');
                    log('üìù Use the buttons above to manage the database');
                    log('‚ö†Ô∏è Always create a backup before deleting data!');
                    
                } else {
                    log(`‚ùå Login failed: ${data.error}`, true);
                }
                
            } catch (error) {
                log(`‚ùå Login error: ${error.message}`, true);
            }
        }
        
        function adminLogout() {
            adminCredentials = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('output').textContent = '';
            log('üëã Logged out successfully', true);
        }
        
        async function makeRequest(endpoint, method = 'GET') {
            if (!adminCredentials) {
                log('‚ùå Not logged in. Please login first.');
                return null;
            }
            
            try {
                log(`üîÑ Making ${method} request to ${endpoint}...`);
                log(`üë§ Using credentials: ${adminCredentials.username}`);
                log(`üåê Full URL: ${API_BASE}/api/admin${endpoint}`);
                
                // Clear any previous output for stats requests
                if (endpoint === '/stats') {
                    log('üìä Fetching database statistics...');
                }
                
                const response = await fetch(`${API_BASE}/api/admin${endpoint}`, {
                    method,
                    headers: {
                        'x-admin-username': adminCredentials.username,
                        'x-admin-password': adminCredentials.password,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üì° Response status: ${response.status} ${response.statusText}`);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    log(`‚ùå Non-JSON response: ${text}`);
                    return null;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Success!`);
                    
                    // Special handling for stats endpoint
                    if (endpoint === '/stats' && data.counts) {
                        log(`üìà Database Statistics:`);
                        log(`   üë• Total Users: ${data.counts.users}`);
                        log(`   üìÅ Portfolios: ${data.counts.portfolios}`);
                        log(`   üìù Contact Forms: ${data.counts.forms}`);
                        log(`   ‚ö° Active Users: ${data.counts.activeUsers || 0} (users with portfolios)`);
                        log(`   üïí Timestamp: ${data.timestamp}`);
                        
                        // Show form status if there are issues
                        if (data.formStatus && data.formStatus.error) {
                            log(`   ‚ö†Ô∏è Form Status: ${data.formStatus.error}`);
                        }
                        
                        // Visual statistics removed - keeping simple text output only
                        
                        if (data.sampleUsers && data.sampleUsers.length > 0) {
                            log(`\nüë• Sample Users (${data.sampleUsers.length}):`);
                            data.sampleUsers.forEach((user, index) => {
                                const portfolioCount = user.portfolios || 0;
                                const status = portfolioCount > 0 ? `‚úÖ ${portfolioCount} portfolio(s)` : '‚ùå No portfolios';
                                log(`   ${index + 1}. ${user.name || user.username} (${user.email}) - ${status}`);
                            });
                        }
                        
                        if (data.samplePortfolios && data.samplePortfolios.length > 0) {
                            log(`\nüìÅ Sample Portfolios (${data.samplePortfolios.length}):`);
                            data.samplePortfolios.forEach((portfolio, index) => {
                                const userName = portfolio.user && portfolio.user[0] ? portfolio.user[0].name : 'Unknown';
                                const createdDate = portfolio.createdAt ? new Date(portfolio.createdAt).toLocaleDateString() : 'Unknown';
                                log(`   ${index + 1}. ${portfolio.data?.name || 'Unnamed'} by ${userName} (${createdDate})`);
                            });
                        }
                    } else {
                        // For other endpoints, show full response
                        log(`üìÑ Response: ${JSON.stringify(data, null, 2)}`);
                    }
                } else {
                    log(`‚ùå Error (${response.status}): ${data.error || 'Unknown error'}`);
                    if (data.hint) {
                        log(`üí° Hint: ${data.hint}`);
                    }
                    if (data.details) {
                        log(`üîç Details: ${data.details}`);
                    }
                }
                
                return data;
            } catch (error) {
                log(`‚ùå Network Error: ${error.message}`);
                log(`üîç Error details: ${error.stack}`);
                
                // Additional debugging for fetch errors
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log(`üåê Check if the server is running on ${API_BASE}`);
                    log(`üîß Try accessing ${API_BASE}/api/health directly in browser`);
                }
                
                return null;
            }
        }
        async function getStats() {
            log('üìä Getting REAL database and storage statistics...');
            
            // First get database stats
            const statsData = await makeRequest('/stats');
            
            // Simple stats only - no visual cards
        }
        
        async function backupData() {
            const data = await makeRequest('/backup-data');
            if (data && data.backup) {
                // Create downloadable backup file
                const blob = new Blob([JSON.stringify(data.backup, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                log('üìÅ Backup file downloaded!');
            }
        }
        
        async function deleteSpecificUser() {
            const email = document.getElementById('userEmail').value;
            if (!email) {
                log('‚ùå Please enter a user email');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete user: ${email}?`)) {
                log('‚ùå Deletion cancelled by user');
                return;
            }
            
            await makeRequest(`/user/${encodeURIComponent(email)}`, 'DELETE');
        }
        
        function clearOutput() {
            document.getElementById('output').textContent = '';
            log('üßπ Output cleared');
        }
        
        function showDebugInfo() {
            log('üîç Debug Information:');
            log(`   üåê API Base URL: ${API_BASE}`);
            log(`   üîê Admin Credentials: ${adminCredentials ? 'Set' : 'Not set'}`);
            if (adminCredentials) {
                log(`   üë§ Username: ${adminCredentials.username}`);
                log(`   üîë Password: ${adminCredentials.password ? '[SET]' : '[NOT SET]'}`);
            }
            log(`   üåç Window Origin: ${window.location.origin}`);
            log(`   üìç Current URL: ${window.location.href}`);
            log(`   üïí Current Time: ${new Date().toISOString()}`);
            log(`   üñ•Ô∏è User Agent: ${navigator.userAgent}`);
        }

        let statsChart = null;

        function displayVisualStats(data) {
            const counts = data.counts;
            
            // Calculate meaningful percentages based on realistic maximums
            const maxUsers = 100; // Reasonable maximum for a portfolio app
            const maxPortfolios = 200; // Users might have multiple portfolios
            const maxForms = 50; // Contact forms, feedback forms, etc.
            
            // Use actual active users from backend if available
            const activeUsers = counts.activeUsers || 0;
            
            // Show the visual stats container
            document.getElementById('statsVisual').style.display = 'block';
            
            // Update stats cards with meaningful percentages
            setTimeout(() => updateStatsCard('usersCount', 'usersProgress', counts.users, maxUsers), 100);
            setTimeout(() => updateStatsCard('portfoliosCount', 'portfoliosProgress', counts.portfolios, maxPortfolios), 300);
            setTimeout(() => updateStatsCard('formsCount', 'formsProgress', counts.forms, maxForms), 500);
            setTimeout(() => updateStatsCard('activeUsersCount', 'activeUsersProgress', activeUsers, counts.users || 1), 700);
            
            // Update storage cards with animation
            setTimeout(() => updateStorageStats(data), 900);
            
            // Create/update chart
            setTimeout(() => createStatsChart(counts), 1100);
            
            // Display sample users if available
            if (data.sampleUsers && data.sampleUsers.length > 0) {
                displaySampleUsers(data.sampleUsers);
            }
            
            // Log form status for debugging
            if (data.formStatus && data.formStatus.error) {
                log(`‚ö†Ô∏è Forms: ${data.formStatus.error}`);
            }
        }

        async function updateStorageStats(data) {
            try {
                log('üìä Fetching real storage usage data...');
                
                // Fetch real storage data from server
                const storageData = await makeRequest('/storage-usage', 'GET');
                
                if (storageData && storageData.storage) {
                    const storage = storageData.storage;
                    
                    log('‚úÖ REAL storage data received from server!');
                    log(`üîç Render: ${storage.renderStorage?.usedMB} MB / ${storage.renderStorage?.limitMB} MB`);
                    log(`üîç MongoDB: ${storage.mongoStorage?.usedMB} MB / ${storage.mongoStorage?.limitMB} MB`);
                    log(`üîç Bandwidth: ${storage.bandwidth?.usedGB} GB / ${storage.bandwidth?.limitGB} GB`);
                    
                    // Use real data from server
                    const renderUsedMB = storage.renderStorage?.usedMB || 0;
                    const renderLimitMB = storage.renderStorage?.limitMB || 512;
                    const renderPercentage = renderLimitMB > 0 ? (renderUsedMB / renderLimitMB) * 100 : 0;
                    
                    const mongoUsedMB = storage.mongoStorage?.usedMB || 0;
                    const mongoLimitMB = storage.mongoStorage?.limitMB || 512;
                    const mongoPercentage = mongoLimitMB > 0 ? (mongoUsedMB / mongoLimitMB) * 100 : 0;
                    
                    const bandwidthUsedGB = storage.bandwidth?.usedGB || 0;
                    const bandwidthLimitGB = storage.bandwidth?.limitGB || 100;
                    const bandwidthPercentage = bandwidthLimitGB > 0 ? (bandwidthUsedGB / bandwidthLimitGB) * 100 : 0;
                    
                    const systemHealth = storage.systemHealth?.score || 100;
                    const healthStatus = storage.systemHealth?.status || 'Unknown';
                    
                    // Update storage cards with real data
                    log(`üîÑ Updating Render card: ${renderUsedMB} MB / ${renderLimitMB} MB (${renderPercentage.toFixed(1)}%)`);
                    updateStorageCard('renderStorageUsed', 'renderStorageProgress', 'renderStorageInfo', 
                                    renderUsedMB, renderLimitMB, renderPercentage, 'MB', 'MB');
                    
                    setTimeout(() => {
                        log(`üîÑ Updating MongoDB card: ${mongoUsedMB} MB / ${mongoLimitMB} MB (${mongoPercentage.toFixed(1)}%)`);
                        updateStorageCard('mongoStorageUsed', 'mongoStorageProgress', 'mongoStorageInfo', 
                                        mongoUsedMB, mongoLimitMB, mongoPercentage, 'MB', 'MB');
                    }, 200);
                    
                    setTimeout(() => {
                        log(`üîÑ Updating Bandwidth card: ${bandwidthUsedGB} GB / ${bandwidthLimitGB} GB (${bandwidthPercentage.toFixed(1)}%)`);
                        updateStorageCard('bandwidthUsed', 'bandwidthProgress', 'bandwidthInfo', 
                                        bandwidthUsedGB, bandwidthLimitGB, bandwidthPercentage, 'GB', 'GB');
                    }, 400);
                    
                    setTimeout(() => {
                        updateHealthCard(systemHealth, healthStatus);
                    }, 600);
                    
                    log('‚úÖ Real storage data loaded successfully');
                    
                    // Show detailed data source information
                    log('üìä STORAGE DATA SOURCES:');
                    
                    if (storage.renderStorage.details.real) {
                        log(`‚úÖ Render Storage: REAL file system data`);
                        log(`   üìÅ Scanned: ${storage.renderStorage.details.scannedDirectories.join(', ')}`);
                        if (storage.renderStorage.details.errors.length > 0) {
                            log(`   ‚ö†Ô∏è Errors: ${storage.renderStorage.details.errors.join(', ')}`);
                        }
                    } else {
                        log(`‚ö†Ô∏è Render Storage: Estimated (${storage.renderStorage.details.reason})`);
                        if (storage.renderStorage.details.calculation) {
                            log(`   üìä ${storage.renderStorage.details.calculation}`);
                        }
                    }
                    
                    if (storage.mongoStorage.details.real) {
                        log(`‚úÖ MongoDB Storage: REAL database statistics`);
                        log(`   üóÑÔ∏è Database: ${storage.mongoStorage.details.databaseName}`);
                        log(`   üìä Data: ${storage.mongoStorage.details.dataSize}MB, Indexes: ${storage.mongoStorage.details.indexSize}MB`);
                        log(`   üìà Collections: ${storage.mongoStorage.details.collections}, Objects: ${storage.mongoStorage.details.objects}`);
                        if (storage.mongoStorage.details.collectionBreakdown) {
                            const collections = Object.entries(storage.mongoStorage.details.collectionBreakdown);
                            collections.forEach(([name, stats]) => {
                                log(`   üìã ${name}: ${stats.size}MB (${stats.count} docs)`);
                            });
                        }
                    } else {
                        log(`‚ö†Ô∏è MongoDB Storage: Estimated (${storage.mongoStorage.details.reason})`);
                        if (storage.mongoStorage.details.calculation) {
                            log(`   üìä ${storage.mongoStorage.details.calculation}`);
                        }
                    }
                    
                    log(`üì° Bandwidth: Smart estimation based on real activity`);
                    if (storage.bandwidth.details.calculation) {
                        log(`   üë• ${storage.bandwidth.details.calculation.baseUsage}`);
                        log(`   üìÅ ${storage.bandwidth.details.calculation.portfolioCreation}`);
                        log(`   üëÄ ${storage.bandwidth.details.calculation.portfolioViews}`);
                        if (storage.bandwidth.details.calculation.adminUsage) {
                            log(`   üõ†Ô∏è ${storage.bandwidth.details.calculation.adminUsage}`);
                        }
                        log(`   üìä ${storage.bandwidth.details.calculation.total}`);
                    }
                    
                    log(`üíö System Health: ${storage.systemHealth.score}% (${storage.systemHealth.status})`);
                    if (storage.systemHealth.details.averageUsage !== undefined) {
                        log(`   üìä Average resource usage: ${storage.systemHealth.details.averageUsage}%`);
                    }
                    
                    // Summary of key findings
                    log(`\nüìã SUMMARY:`);
                    log(`‚úÖ Your Render storage usage is very low (${storage.renderStorage.usedMB} MB of 512 MB)`);
                    log(`‚úÖ MongoDB usage is efficient (${storage.mongoStorage.usedMB} MB of 512 MB)`);
                    log(`‚úÖ Bandwidth usage is conservative (${storage.bandwidth.usedGB} GB of 100 GB monthly)`);
                    log(`‚úÖ All systems are operating within free tier limits`)
                } else {
                    throw new Error('No storage data received from server');
                }
                
            } catch (error) {
                log(`‚ùå Could not fetch real storage data: ${error.message}`);
                log(`üîç Error details: ${error.stack || 'No stack trace'}`);
                log('üìä Falling back to estimated storage calculations...');
                log('üí° This means the /storage-usage endpoint is not responding correctly');
                
                // Fallback to estimated calculations if real data unavailable
                await updateStorageStatsEstimated(data);
            }
        }

        async function updateStorageStatsEstimated(data) {
            const counts = data.counts;
            
            // More realistic estimates based on actual usage patterns
            const avgUserSize = 1.5; // KB per user (more realistic)
            const avgPortfolioSize = 25; // KB per portfolio (more realistic)
            const avgFormSize = 3; // KB per form (more realistic)
            
            const mongoUsedKB = (counts.users * avgUserSize) + (counts.portfolios * avgPortfolioSize) + (counts.forms * avgFormSize);
            const mongoUsedMB = Math.round(mongoUsedKB / 1024 * 100) / 100; // More precision
            const mongoLimitMB = 512;
            const mongoPercentage = Math.min((mongoUsedMB / mongoLimitMB) * 100, 100);
            
            // Try to get actual file sizes from server
            let renderUsedMB = 0;
            try {
                const fileStats = await makeRequest('/admin/file-stats', 'GET');
                renderUsedMB = fileStats?.totalSizeMB || (counts.portfolios * 0.05); // 50KB per portfolio fallback
            } catch {
                renderUsedMB = counts.portfolios * 0.05; // 50KB per portfolio fallback
            }
            
            const renderLimitMB = 512; // Correct Render free tier limit
            const renderPercentage = Math.min((renderUsedMB / renderLimitMB) * 100, 100);
            
            // Try to get actual bandwidth from server logs
            let bandwidthUsedGB = 0;
            try {
                const bandwidthStats = await makeRequest('/admin/bandwidth-stats', 'GET');
                bandwidthUsedGB = bandwidthStats?.monthlyUsageGB || (counts.users * 0.01); // 10MB per user fallback
            } catch {
                bandwidthUsedGB = counts.users * 0.01; // 10MB per user fallback
            }
            
            const bandwidthLimitGB = 100;
            const bandwidthPercentage = Math.min((bandwidthUsedGB / bandwidthLimitGB) * 100, 100);
            
            // Calculate system health
            const avgUsage = (mongoPercentage + renderPercentage + bandwidthPercentage) / 3;
            const systemHealth = Math.max(100 - avgUsage, 0);
            const healthStatus = systemHealth > 80 ? 'Excellent' : 
                               systemHealth > 60 ? 'Good' : 
                               systemHealth > 40 ? 'Fair' : 'Needs Attention';
            
            // Update storage cards
            updateStorageCard('renderStorageUsed', 'renderStorageProgress', 'renderStorageInfo', 
                            renderUsedMB, renderLimitMB, renderPercentage, 'MB', 'GB');
            
            setTimeout(() => {
                updateStorageCard('mongoStorageUsed', 'mongoStorageProgress', 'mongoStorageInfo', 
                                mongoUsedMB, mongoLimitMB, mongoPercentage, 'MB', 'MB');
            }, 200);
            
            setTimeout(() => {
                updateStorageCard('bandwidthUsed', 'bandwidthProgress', 'bandwidthInfo', 
                                bandwidthUsedGB, bandwidthLimitGB, bandwidthPercentage, 'GB', 'GB');
            }, 400);
            
            setTimeout(() => {
                updateHealthCard(systemHealth, healthStatus);
            }, 600);
            
            log('üìä Using estimated storage data (real data not available)');
        }

        function updateStorageCard(countId, progressId, infoId, used, limit, percentage, usedUnit, limitUnit) {
            const countElement = document.getElementById(countId);
            const progressElement = document.getElementById(progressId);
            const infoElement = document.getElementById(infoId);
            
            // Animate number counting with proper decimal places
            const displayUsed = usedUnit === 'MB' ? Math.round(used * 100) / 100 : Math.round(used * 1000) / 1000;
            animateNumber(countElement, 0, displayUsed, 1000);
            
            // Update info text with proper formatting
            let limitDisplay;
            if (limitUnit === 'MB' && limit >= 1024) {
                limitDisplay = `${Math.round(limit/1024 * 100) / 100} GB`;
            } else {
                limitDisplay = `${limit} ${limitUnit}`;
            }
            
            const usedDisplay = usedUnit === 'MB' ? `${displayUsed} MB` : `${displayUsed} ${usedUnit}`;
            infoElement.textContent = `${usedDisplay} / ${limitDisplay}`;
            
            // Animate progress bar with color coding
            setTimeout(() => {
                const safePercentage = Math.min(Math.max(percentage, 0), 100);
                progressElement.style.width = safePercentage + '%';
                progressElement.textContent = Math.round(safePercentage) + '%';
                
                // Color coding based on usage
                if (safePercentage > 90) {
                    progressElement.style.background = 'linear-gradient(90deg, #dc3545, #c82333)'; // Red
                } else if (safePercentage > 75) {
                    progressElement.style.background = 'linear-gradient(90deg, #ffc107, #e0a800)'; // Yellow
                } else if (safePercentage > 50) {
                    progressElement.style.background = 'linear-gradient(90deg, #fd7e14, #e8590c)'; // Orange
                } else {
                    // Keep original color for low usage
                }
            }, 200);
        }

        function updateHealthCard(health, status) {
            const countElement = document.getElementById('systemHealth');
            const progressElement = document.getElementById('healthProgress');
            const infoElement = document.getElementById('healthInfo');
            
            // Animate health score
            animateNumber(countElement, 100, health, 1000);
            
            // Update status
            infoElement.textContent = status;
            
            // Animate progress bar
            setTimeout(() => {
                progressElement.style.width = health + '%';
                progressElement.textContent = Math.round(health) + '%';
                
                // Color coding for health
                if (health > 80) {
                    progressElement.style.background = 'linear-gradient(90deg, #28a745, #218838)'; // Green
                } else if (health > 60) {
                    progressElement.style.background = 'linear-gradient(90deg, #20c997, #1aa179)'; // Teal
                } else if (health > 40) {
                    progressElement.style.background = 'linear-gradient(90deg, #ffc107, #e0a800)'; // Yellow
                } else {
                    progressElement.style.background = 'linear-gradient(90deg, #dc3545, #c82333)'; // Red
                }
            }, 200);
        }

        function updateStatsCard(countId, progressId, value, total) {
            const countElement = document.getElementById(countId);
            const progressElement = document.getElementById(progressId);
            
            // Animate number counting
            animateNumber(countElement, 0, value, 1000);
            
            // Animate progress bar with better percentage calculation
            let percentage;
            let displayText;
            
            if (countId === 'activeUsersCount') {
                // For active users, show percentage of total users
                percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                displayText = `${percentage}%`;
            } else {
                // For other metrics, show percentage of reasonable maximum
                percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                // Cap at 100% for display purposes
                const displayPercentage = Math.min(percentage, 100);
                displayText = `${displayPercentage}%`;
                
                // If over 100%, show the actual count instead
                if (percentage > 100) {
                    displayText = `${value}`;
                }
            }
            
            setTimeout(() => {
                const safePercentage = Math.min(Math.max(percentage, 0), 100);
                progressElement.style.width = safePercentage + '%';
                progressElement.textContent = displayText;
                
                // Color coding based on the type of metric
                if (countId === 'activeUsersCount') {
                    // Green gradient for active users (higher is better)
                    progressElement.style.background = 'linear-gradient(90deg, #28a745, #218838)';
                } else {
                    // Default colors for other metrics
                    if (safePercentage > 80) {
                        progressElement.style.background = 'linear-gradient(90deg, #ffc107, #e0a800)'; // Yellow for high usage
                    } else {
                        // Keep original color
                    }
                }
            }, 200);
        }

        function animateNumber(element, start, end, duration) {
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const current = Math.floor(start + (end - start) * progress);
                element.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        function createStatsChart(counts) {
            try {
                const canvas = document.getElementById('statsChart');
                if (!canvas) {
                    console.error('Canvas element not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get canvas context');
                    return;
                }
                
                // Destroy existing chart if it exists
                if (statsChart) {
                    statsChart.destroy();
                    statsChart = null;
                }
                
                // Ensure we have valid data
                const users = counts.users || 0;
                const portfolios = counts.portfolios || 0;
                const forms = counts.forms || 0;
                const total = users + portfolios + forms;
                
                // If no data, show a message
                if (total === 0) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#666';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data to display', canvas.width / 2, canvas.height / 2);
                    return;
                }
                
                // Create the chart
                statsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['üë• Users', 'üìÅ Portfolios', 'üìù Forms'],
                        datasets: [{
                            data: [users, portfolios, forms],
                            backgroundColor: [
                                '#007bff',
                                '#28a745',
                                '#ffc107'
                            ],
                            borderColor: [
                                '#ffffff'
                            ],
                            borderWidth: 3,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0';
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            duration: 1000
                        }
                    }
                });
                
                log('üìä Chart created successfully');
                
            } catch (error) {
                console.error('Error creating chart:', error);
                log(`‚ùå Chart creation failed: ${error.message}`);
            }
        }

        function displaySampleUsers(users) {
            const container = document.getElementById('sampleUsersContainer');
            const usersList = document.getElementById('sampleUsersList');
            
            container.style.display = 'block';
            usersList.innerHTML = '';
            
            users.forEach((user, index) => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const initials = (user.name || user.username || user.email)
                    .split(' ')
                    .map(word => word[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
                
                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${initials}</div>
                        <div>
                            <div style="font-weight: bold;">${user.name || user.username || 'Unknown'}</div>
                            <div style="color: #666; font-size: 0.9em;">${user.email}</div>
                        </div>
                    </div>
                    <div style="color: #28a745; font-weight: bold;">
                        ${user.portfolios || 0} üìÅ
                    </div>
                `;
                
                // Add with animation
                userItem.style.opacity = '0';
                userItem.style.transform = 'translateY(20px)';
                usersList.appendChild(userItem);
                
                setTimeout(() => {
                    userItem.style.transition = 'all 0.3s ease';
                    userItem.style.opacity = '1';
                    userItem.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        async function deleteAllUsers() {
            if (!confirm('‚ö†Ô∏è Are you ABSOLUTELY sure you want to delete ALL users and portfolios?')) {
                log('‚ùå Deletion cancelled by user');
                return;
            }
            
            if (!confirm('üö® This action cannot be undone! This will delete ALL data!')) {
                log('‚ùå Final confirmation cancelled');
                return;
            }
            
            const finalConfirm = prompt('Type "DELETE ALL" to proceed:');
            if (finalConfirm !== 'DELETE ALL') {
                log('‚ùå Confirmation text did not match. Deletion cancelled.');
                return;
            }
            
            log('üßπ Starting complete database cleanup...');
            await makeRequest('/cleanup-test-users', 'DELETE');
        }
        
        // Initialize
        log('üîê Please login to access the admin panel', true);
    </script>
</body>
</html>